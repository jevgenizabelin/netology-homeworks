# Домашнее задание к занятию "6.6. Troubleshooting"

## Задача 1

- Для начала нужно выяснить, что это за долгий запрос и найти его `opid`

`db.currentOp({"secs_running":{$gte:180}})`

Чтобы завершить запрос, выполнить команду:

`db.killOp("opid")`

- Чтобы решить проблему с долгими запросами в mongodb, можно провести анализ этого запроса и предоставить разработчикам или изучить самому:

`db.inventory.find({ quantity: { $gte: 170, $lte: 200 } }).explain("executionStats")`

Так же можно включить профилирование базы данных с флагом `--slowms` и провести анализ на основе собранных данных.

Возможно надо добавить ресурсов на сервере, добавить индексы и оптимизировать запросы.

## Задача 2

- Скорее всего используется "Активное истечение срока действия ключей".
Цикл истечения запускается каждые 100 миллисекунд и ищет, что больше чем у 25% ключей истек срок.
Это означает, что если в базе данных есть много ключей, срок действия которых истекает за одну секунду, 
  и они составляют не менее 25%, Redis может заблокировать операции, чтобы получить процент ключей, срок действия которых уже истек, ниже 25%.
Это необходимо, чтобы избежать использования слишком большого количества памяти для ключей, срок действия которых уже истек.
Т.е. если много ключей истекают в один и тот же момент, это может быть причиной задержки.
Возможно при увеличении реплик, может возникнуть нагрузка на память,
во избежании которой, redis и блокирует операции записи.  
  
## Задача 3

- Один из вариантов возникновения этой ошибки, может быть очень большой запрос,
включающий в себя миллионы строк. Тогда можно попробовать увеличить параметр `net_read_timeout` со значения по умолчанию 30 секунд на 60 или больше.
Так же ошибка может произойти, когда клиент пытается установить начальное соединение с сервером.
Если между клиентом и сервером очень большое расстояние или медленное соединение,
можно увеличить параметр `connect_timeout` на несколько секунд больше.
Ещё можем столкнуться с проблемой со значениями BLOB, превышающими max_allowed_packet и увидеть ошибку `ER_NET_PACKET_TOO_LARGE `.
Тогда нужно увеличить параметр `max_allowed_packet`.

## Задача 4

- 
